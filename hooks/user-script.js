document.addEventListener("DOMContentLoaded", function() {
    const themeToggle = document.getElementById("theme-toggle");
    const channelsList = document.getElementById("channels-list");
    const searchInput = document.getElementById("search-input");
    const clearSearch = document.getElementById("clear-search");
    const matchesButton = document.getElementById("matches-button");
    const playerPage = document.getElementById("player-page");
    const backButton = document.getElementById("back-button");
    const matchesPage = document.getElementById("matches-page");
    const backToChannelsFromMatches = document.getElementById("back-to-channels-from-matches");
    const channelsPage = document.getElementById("channels-page");

    let userTimeOffset = 0;
    let previousPage = "channels"; // ŸÑÿ™ÿ™ÿ®ÿπ ÿßŸÑÿµŸÅÿ≠ÿ© ÿßŸÑÿ≥ÿßÿ®ŸÇÿ© (ÿßŸÑŸÇŸÜŸàÿßÿ™ ÿ£Ÿà ÿßŸÑŸÖÿ®ÿßÿ±Ÿäÿßÿ™)

    // ÿßŸÑŸÉÿ¥ŸÅ ÿπŸÜ ÿßŸÑÿ¨Ÿáÿßÿ≤ (Ÿáÿßÿ™ŸÅ ÿ£Ÿà ŸÉŸÖÿ®ŸäŸàÿ™ÿ±)
    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

    // ÿ™ÿ®ÿØŸäŸÑ ÿßŸÑÿ´ŸäŸÖ
    themeToggle.addEventListener("click", () => {
        document.body.classList.toggle("dark-theme");
        themeToggle.innerHTML = document.body.classList.contains("dark-theme") ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
    });

    // ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÇŸÜŸàÿßÿ™
    function loadChannels() {
        channelsList.innerHTML = "";
        db.collection("groups").orderBy("createdAt", "asc").get().then((groupsSnapshot) => {
            groupsSnapshot.forEach((groupDoc) => {
                const group = groupDoc.data();
                const groupSection = document.createElement("div");
                groupSection.classList.add("group-section");
                groupSection.innerHTML = `
                    <h3 class="group-name">${group.name}</h3>
                    <div class="channels-container"></div>
                `;
                channelsList.appendChild(groupSection);

                const channelsContainer = groupSection.querySelector(".channels-container");

                db.collection("channels").where("group", "==", groupDoc.id).orderBy("createdAt", "asc").get().then((channelsSnapshot) => {
                    channelsSnapshot.forEach((channelDoc) => {
                        const channel = channelDoc.data();
                        const channelCard = document.createElement("div");
                        channelCard.classList.add("channel-card");
                        channelCard.innerHTML = `
                            <img src="${channel.image}" alt="${channel.name}">
                            <p>${channel.name}</p>
                        `;
                        channelCard.setAttribute("data-url", channel.url);
                        channelCard.setAttribute("data-key", channel.key || "");
                        channelsContainer.appendChild(channelCard);

                        channelCard.addEventListener("click", () => {
                            const url = channelCard.getAttribute("data-url");
                            const key = channelCard.getAttribute("data-key");
                            playChannel(url, key);
                            playerPage.style.display = "block";
                            channelsPage.style.display = "none";
                            previousPage = "channels"; // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿµŸÅÿ≠ÿ© ÿßŸÑÿ≥ÿßÿ®ŸÇÿ©
                        });
                    });
                });
            });
        });
    }

    // ÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑŸÇŸÜÿßÿ©
    function playChannel(url, key) {
        if (!url) {
            console.error("ÿ±ÿßÿ®ÿ∑ ÿßŸÑŸÇŸÜÿßÿ© ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ!");
            return;
        }

        const config = {
            playlist: [{
                sources: [{
                    file: url,
                    type: getStreamType(url),
                    drm: key ? {
                        clearkey: {
                            keyId: key.split(":")[0],
                            key: key.split(":")[1],
                            robustnessLevel: "SW_SECURE_CRYPTO"
                        }
                    } : null
                }]
            }],
            width: "100%",
            height: "100%",
            autostart: true,
            cast: {},
            sharing: false
        };

        const playerInstance = jwplayer("player").setup(config);

        // ÿ•ÿ∞ÿß ŸÉÿßŸÜ ÿßŸÑÿ¨Ÿáÿßÿ≤ Ÿáÿßÿ™ŸÅÿå ŸÇŸÖ ÿ®ÿ•ÿ∂ÿßŸÅÿ© ÿØÿπŸÖ ŸÑŸÑŸàÿ∂ÿπ ÿßŸÑÿ£ŸÅŸÇŸä (Landscape) ÿπŸÜÿØ ÿßŸÑÿ∂ÿ∫ÿ∑ ÿπŸÑŸâ ÿ≤ÿ± ÿ™ŸÉÿ®Ÿäÿ± ÿßŸÑÿ¥ÿßÿ¥ÿ©
        if (isMobile) {
            playerInstance.on('fullscreen', function(event) {
                if (event.fullscreen) {
                    screen.orientation.lock('landscape').catch(() => {
                        console.log("ŸÑŸÖ Ÿäÿ™ŸÖŸÉŸÜ ÿßŸÑŸÖÿ™ÿµŸÅÿ≠ ŸÖŸÜ ŸÇŸÅŸÑ ÿßŸÑÿ¥ÿßÿ¥ÿ© ŸÅŸä ÿßŸÑŸàÿ∂ÿπ ÿßŸÑÿ£ŸÅŸÇŸä.");
                    });
                } else {
                    screen.orientation.unlock();
                }
            });
        }
    }

    // ÿ™ÿ≠ÿØŸäÿØ ŸÜŸàÿπ ÿßŸÑŸÖŸÑŸÅ ÿ™ŸÑŸÇÿßÿ¶ŸäŸãÿß
    function getStreamType(url) {
        if (url.includes(".m3u8")) {
            return "hls";
        } else if (url.includes(".mpd")) {
            return "dash";
        } else if (url.includes(".mp4") || url.includes(".m4v")) {
            return "mp4";
        } else {
            return "auto";
        }
    }

    // ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ÿßŸÑŸÇŸÜŸàÿßÿ™
    searchInput.addEventListener("input", () => {
        const searchTerm = searchInput.value.toLowerCase();
        document.querySelectorAll(".group-section").forEach((group) => {
            const groupName = group.querySelector(".group-name").textContent.toLowerCase();
            const channels = group.querySelectorAll(".channel-card");
            let hasVisibleChannels = false;

            channels.forEach((channel) => {
                const channelName = channel.querySelector("p").textContent.toLowerCase();
                if (channelName.includes(searchTerm)) {
                    channel.style.display = "flex";
                    hasVisibleChannels = true;
                } else {
                    channel.style.display = "none";
                }
            });

            group.style.display = hasVisibleChannels || groupName.includes(searchTerm) ? "block" : "none";
        });
    });

    // ŸÖÿ≥ÿ≠ ÿßŸÑÿ®ÿ≠ÿ´
    clearSearch.addEventListener("click", () => {
        searchInput.value = "";
        document.querySelectorAll(".group-section, .channel-card").forEach((element) => {
            element.style.display = "block";
        });
    });

    // ÿπÿ±ÿ∂ ÿ¨ÿØŸàŸÑ ÿßŸÑŸÖÿ®ÿßÿ±Ÿäÿßÿ™
    matchesButton.addEventListener("click", () => {
        matchesPage.style.display = "block";
        channelsPage.style.display = "none";
        loadMatches();
        previousPage = "matches"; // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿµŸÅÿ≠ÿ© ÿßŸÑÿ≥ÿßÿ®ŸÇÿ©
    });

    // ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖÿ®ÿßÿ±Ÿäÿßÿ™
    function loadMatches() {
        const matchesTable = document.getElementById("matches-table");
        matchesTable.innerHTML = "";

        db.collection("matches").orderBy("createdAt", "asc").get().then((querySnapshot) => {
            querySnapshot.forEach((doc) => {
                const match = doc.data();
                const matchItem = document.createElement("div");
                matchItem.classList.add("match-item");

                const team1Image = match.team1Image;
                const team2Image = match.team2Image;
                const matchTimeUTC = new Date(match.matchTime);
                const currentTimeUTC = new Date();

                const timeDiff = (currentTimeUTC - matchTimeUTC) / (1000 * 60);

                let matchStatus = "";
                let matchStatusClass = "";
                if (timeDiff < -15) {
                    matchStatus = `ÿßŸÑŸàŸÇÿ™: ${matchTimeUTC.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`;
                    matchStatusClass = "match-status";
                } else if (timeDiff >= -15 && timeDiff < 0) {
                    matchStatus = "ÿ™ÿ®ÿØÿ£ ŸÇÿ±Ÿäÿ®Ÿãÿß";
                    matchStatusClass = "match-status soon";
                } else if (timeDiff >= 0 && timeDiff < 120) {
                    matchStatus = "ÿ¨ÿßÿ±Ÿäÿ© ÿßŸÑÿ¢ŸÜ";
                    matchStatusClass = "match-status live";
                } else {
                    db.collection("matches").doc(doc.id).delete();
                    return;
                }

                matchItem.innerHTML = `
                    <div class="teams-section">
                        <div class="team">
                            <img src="${team1Image}" alt="${match.team1}">
                            <p>${match.team1}</p>
                        </div>
                        <div class="vs-time">
                            <div class="vs">VS</div>
                            <div class="${matchStatusClass}">${matchStatus}</div>
                        </div>
                        <div class="team">
                            <img src="${team2Image}" alt="${match.team2}">
                            <p>${match.team2}</p>
                        </div>
                    </div>
                    <div class="match-details">
                        <p><span class="icon">üèÜ</span> ${match.matchLeague}</p>
                        <p><span class="icon">üé§</span> ${match.commentator}</p>
                    </div>
                    <button class="watch-button ${timeDiff >= -15 && timeDiff < 120 ? 'active' : 'inactive'}" data-url="${match.channelUrl}" data-key="${match.key || ''}" ${timeDiff >= -15 && timeDiff < 120 ? '' : 'disabled'}>
                        ŸÖÿ¥ÿßŸáÿØÿ© ÿßŸÑŸÖÿ®ÿßÿ±ÿßÿ©
                    </button>
                `;

                matchesTable.appendChild(matchItem);
            });

            document.querySelectorAll(".watch-button").forEach(button => {
                button.addEventListener("click", () => {
                    const url = button.getAttribute("data-url");
                    const key = button.getAttribute("data-key");
                    playChannel(url, key);
                    matchesPage.style.display = "none";
                    playerPage.style.display = "block";
                    previousPage = "matches"; // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿµŸÅÿ≠ÿ© ÿßŸÑÿ≥ÿßÿ®ŸÇÿ©
                });
            });
        });
    }

    // ÿ≤ÿ± ÿßŸÑÿ±ÿ¨Ÿàÿπ
    backButton.addEventListener("click", () => {
        // ÿ•ŸäŸÇÿßŸÅ ÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑŸÇŸÜÿßÿ© ÿπŸÜÿØ ÿßŸÑÿ∂ÿ∫ÿ∑ ÿπŸÑŸâ ÿ≤ÿ± ÿßŸÑÿ±ÿ¨Ÿàÿπ
        jwplayer("player").stop();
        playerPage.style.display = "none";
        if (previousPage === "channels") {
            channelsPage.style.display = "block";
        } else if (previousPage === "matches") {
            matchesPage.style.display = "block";
        }
    });

    // ÿ≤ÿ± ÿßŸÑÿ±ÿ¨Ÿàÿπ ŸÖŸÜ ÿ¨ÿØŸàŸÑ ÿßŸÑŸÖÿ®ÿßÿ±Ÿäÿßÿ™
    backToChannelsFromMatches.addEventListener("click", () => {
        matchesPage.style.display = "none";
        channelsPage.style.display = "block";
    });

    // ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÇŸÜŸàÿßÿ™ ÿπŸÜÿØ ÿ®ÿØÿ° ÿßŸÑÿ™ÿ¥ÿ∫ŸäŸÑ
    loadChannels();
});
